# React Fiber 详解

React Fiber 是 React 16 版本中引入的一个核心架构改进，旨在解决早期版本中由于递归比对 Virtual DOM 导致的性能问题。Fiber 通过将任务拆分成可中断的小单元，并允许在浏览器空闲时间执行，从而显著提高了 React 应用的性能和响应能力。以下是对 React Fiber 的详细解析：

## 一、Fiber 的背景与目的

在 React 15 版本中，React 使用的是递归的方式来对比 Virtual DOM 树，找出差异部分并更新到真实 DOM 中。然而，这种方式存在几个显著的问题：

- **递归过程无法中断**：递归调用一旦开始，就必须执行完成，不能在中途被打断。如果 Virtual DOM 树非常庞大，递归比对过程就会长期占用主线程，导致其他任务（如用户输入处理、页面渲染等）被阻塞。
- **性能瓶颈**：由于 JavaScript 是单线程的，且浏览器 GUI 线程的渲染和 JavaScript 线程的执行是互斥的，长时间占用主线程会导致页面渲染延迟，用户体验下降。

为了解决这些问题，React 团队引入了 Fiber 架构。Fiber 的主要目的是提高 React 渲染页面的效率，减少页面卡顿，提升用户体验。

## 二、Fiber 的核心特性

1. **可中断的任务执行**：
   Fiber 将更新任务拆分成多个小单元（即 Fiber 节点），每个小单元都可以被中断和重新调度。这样，当浏览器有更高优先级的任务需要处理时（如用户输入、页面滚动等），React 可以暂停当前的更新任务，优先处理这些紧急任务。

2. **利用浏览器空闲时间**：
   Fiber 利用 `requestIdleCallback` API（在旧版浏览器中通过 polyfill 实现）来在浏览器空闲时间执行更新任务。这样，React 可以在不影响用户体验的前提下，尽可能快地完成更新。

3. **优先级管理**：
   Fiber 引入了优先级的概念，允许开发者为不同的更新任务设置不同的优先级。高优先级的任务可以中断低优先级的任务，从而确保关键路径上的更新能够优先执行。

4. **新的数据结构**：
   Fiber 是一种类似双向链表的数据结构，每个 Fiber 节点代表一个工作单元。React 会为每个 DOM 节点生成一个 Fiber 节点，并通过 child、sibling 和 return 指针将这些节点连接起来，形成一个 Fiber 树。这个 Fiber 树是 React 进行更新和渲染的基础。

## 三、Fiber 的工作流程

1. **创建更新**：
   当组件的状态或属性发生变化时，React 会创建一个更新任务并将其加入到任务队列中。

2. **任务调度**：
   React 调度器会根据任务的优先级和浏览器的空闲时间来安排任务的执行。

3. **构建 WIP（WorkInProgress）树**：
   在浏览器空闲时间，React 会从根节点开始遍历 Fiber 树，并为每个节点创建一个对应的 WIP 节点。这些 WIP 节点组成了一个新的 Fiber 树（即 WIP 树），用于表示即将渲染的 UI 状态。

4. **执行更新**：
   React 会遍历 WIP 树，并对比新旧节点之间的差异。对于需要更新的节点，React 会执行相应的更新逻辑，并将更新结果应用到真实 DOM 上。

5. **提交更新**：
   当所有更新都执行完毕后，React 会将 current 指针指向 WIP 树，并将 WIP 树作为新的 current 树。此时，页面上展示的就是更新后的 UI 状态。

## 四、总结

React Fiber 是 React 团队为了解决早期版本中性能问题而引入的一个核心架构改进。它通过将任务拆分成可中断的小单元、利用浏览器空闲时间执行更新任务、引入优先级管理和新的数据结构等方式，显著提高了 React 应用的性能和响应能力。随着 React 的不断发展，Fiber 架构已经成为 React 应用的基石之一。
