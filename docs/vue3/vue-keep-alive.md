# keep-alive 具体缓存的是什么?

`keep-alive` 在 Vue.js 中是一个内置组件，用于缓存组件实例，而不是直接缓存数据。然而，由于组件实例被缓存，其内部的状态（包括数据）也被间接缓存。`keep-alive` 缓存的数据结构主要涉及到一个缓存对象（cache）和一个存储组件 key 的数组（keys）。

## 缓存数据结构概述

1. **缓存对象（cache）**：

   - 这是一个对象，用于存储被缓存的组件实例。
   - 对象的键（key）是组件的唯一标识符（通常是组件的 `key` 属性或组件的构造函数 ID 加上可能的标签名），值（value）是对应的组件实例。
   - 当组件需要被缓存时，其 vnode 实例（虚拟节点）会被添加到这个对象中，并通过其 key 进行索引。

2. **组件 key 数组（keys）**：
   - 这是一个数组，用于存储当前缓存中所有组件的 key。
   - 数组中的元素顺序可能反映了组件的最近使用情况（尽管这取决于具体的缓存策略，如 LRU 缓存策略）。
   - 当组件被访问时，如果它已经在缓存中，它的 key 会在数组中的位置被更新，以反映其最近使用状态。

## LRU 缓存策略（Least Recently Used）

- 在 Vue 的 `keep-alive` 实现中，通常会采用 LRU 缓存策略来管理缓存空间。
- 当缓存的组件数量超过设定的最大限制（通过 `max` 属性指定）时，最早未使用的组件实例将被从缓存中移除，以释放空间给新的组件实例。
- 这意味着在组件 key 数组中，位于数组开头的组件实例可能是最早未使用的，因此最有可能被移除。

## 缓存过程

1. **组件创建**：

   - 当组件首次被创建时，如果它被包裹在 `keep-alive` 中，并且满足缓存条件（如 `include` 和 `exclude` 属性），则它的实例会被添加到缓存对象中，并将其 key 添加到组件 key 数组中。

2. **组件访问**：

   - 当用户访问一个已经被缓存的组件时，`keep-alive` 会从缓存对象中获取该组件的实例，并将其重新挂载到 DOM 上，而不是重新创建组件实例。
   - 同时，该组件的 key 在组件 key 数组中的位置会被更新，以反映其最近使用状态。

3. **缓存更新**：

   - 如果组件的状态发生变化（例如，用户与组件交互导致数据更新），这些变化会直接影响缓存中的组件实例。
   - 因为组件实例被缓存，所以其内部状态（包括数据）也会被保留。

4. **缓存清理**：
   - 当缓存的组件数量超过设定的最大限制时，`keep-alive` 会根据 LRU 缓存策略移除最早未使用的组件实例。
   - 这意味着那些长时间未被访问的组件实例将被从缓存中移除，以释放空间给新的组件实例。

## 生命周期钩子

当组件被`keep-alive`包裹时，它会有两个额外的生命周期钩子：`activated`和`deactivated`。

- `activated`：当组件被激活时调用，对应于之前的`mounted`或`updated`钩子，但在这个上下文中它只在组件被缓存后重新渲染时调用。
- `deactivated`：当组件被停用时调用，对应于之前的`beforeDestroy`钩子，但在这个上下文中它会在组件被缓存之前调用。

## 使用场景

### 1. 列表渲染

- **场景描述**：当需要渲染大量的列表项时，如果列表项较为复杂或包含大量数据，每次数据更新都重新渲染整个列表可能会导致性能问题。
- **解决方案**：使用 `keep-alive` 缓存列表组件，避免在数据更新时重复渲染整个列表，只更新需要变化的部分。

### 2. 路由缓存

- **场景描述**：在单页面应用（SPA）中，路由切换频繁，如果每次切换都重新渲染组件，会导致性能下降和用户体验不佳。
- **解决方案**：在路由配置中，通过 `meta` 字段标记需要缓存的路由组件，然后在根组件或布局组件中使用 `keep-alive` 包裹 `<router-view>`，根据路由的 `meta` 字段判断是否缓存该组件。

### 3. 表单数据展示

- **场景描述**：在表单数据展示场景中，如果表单组件较为复杂或包含大量计算属性，每次从服务器获取新数据后重新渲染表单组件可能会导致性能问题。
- **解决方案**：使用 `keep-alive` 缓存表单组件，当数据更新时，只更新表单的数据部分，而不是重新渲染整个组件。

### 4. 复杂组件的复用

- **场景描述**：在应用中，有些组件可能较为复杂，包含大量的子组件和计算属性，这些组件的渲染和销毁成本较高。
- **解决方案**：使用 `keep-alive` 缓存这些复杂组件，避免在组件切换时重复渲染和销毁，提高性能。

### 5. 用户体验优化

- **场景描述**：在某些场景下，用户可能希望回到之前浏览的页面时，页面能够保持之前的状态，而不是重新加载。
- **解决方案**：使用 `keep-alive` 缓存这些页面，当用户再次访问时，可以直接显示缓存的页面，提高用户体验。

## 结论

`keep-alive` 在 Vue.js 中通过缓存组件实例来间接缓存组件的状态（包括数据）。其缓存数据结构主要包括一个缓存对象和一个组件 key 数组，并采用 LRU 缓存策略来管理缓存空间。通过这种方式，`keep-alive` 能够提高应用的性能和用户体验，特别是在需要频繁切换组件的场景中。
